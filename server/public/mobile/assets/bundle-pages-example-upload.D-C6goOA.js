import{aL as e,aM as l,aN as t,d as a,G as s,H as o,r as i,w as u,e as r,J as n,f as d,s as c,Q as p,c as m,g as f,k as x,a as y,h as g,l as b,n as h,p as v,D as w,a4 as z,a3 as _,L as k,m as T,t as I,j as F,F as M,C as V,aO as j,i as C,aP as S,q as P,b as O,K as U}from"./index-4glTkX_N.js";import"./types.DQ6PHZfF.js";import"./index.mNFG9pMF.js";import"./index.D9GroqTO.js";function B(a){return"type"in a&&"image"===a.type?function(l){return new Promise((t,a)=>{e({count:l.count,sizeType:l.sizeType,sourceType:l.sourceType,extension:l.extension,success(e){t(D(e,"image"))},fail(e){"chooseImage:fail cancel"!==e.errMsg&&a({errMsg:e.errMsg})}})})}(a):"type"in a&&"video"===a.type?function(e){return new Promise((t,a)=>{l({camera:e.camera,compressed:e.compressed,maxDuration:e.maxDuration,sourceType:e.sourceType,extension:e.extension,success:e=>{t(D({errMsg:"chooseVideo:ok",tempFilePaths:[e.tempFilePath],tempFiles:[{name:e.tempFile&&e.tempFile.name||"",path:e.tempFilePath,size:e.size,type:e.tempFile&&e.tempFile.type||"",width:e.width,height:e.height,duration:e.duration,fileType:"video"}]},"video"))},fail(e){"chooseVideo:fail cancel"!==e.errMsg&&a({errMsg:e.errMsg})}})})}(a):function(e){return new Promise((l,a)=>{let s=t;"function"==typeof uni.chooseMessageFile&&(s=uni.chooseMessageFile),s({type:"all",count:e.count,extension:e.extension,success(e){l(D(e))},fail(e){"chooseFile:fail cancel"!==e.errMsg&&a({errMsg:e.errMsg})}})})}(a)}function D(e,l){return e.tempFiles.forEach(e=>{e.name||(e.name=e.path.substring(e.path.lastIndexOf("/")+1)),l&&(e.fileType=l)}),e.tempFilePaths||(e.tempFilePaths=e.tempFiles.map(e=>e.path)),e}const L=e=>(console.log(e),{fileType:e.fileType,name:e.name,size:e.size,ext:E(e.name),url:e.tempFilePath||e.path,progress:0,status:"uploading",errMsg:""}),A=e=>{const l=e.substring(e.lastIndexOf(".")).toLowerCase();return[".jpg",".jpeg",".png",".gif",".ico",".webp",".bmp",".svg",".tif",".tiff"].some(e=>l.includes(e))?"image":[".mp4",".webm",".mov",".mkv",".avi",".wmv",".mpg",".mpeg",".m4v",".ogv",".av1",".dv",".dif"].some(e=>l.includes(e))?"video":"all"},$=e=>{if(e){const l=e.lastIndexOf("."),t=e.lastIndexOf("/");return-1===l?e:e.substring(t+1)}return""},E=e=>{if(e){const l=e.lastIndexOf("."),t=e.length;return e.substring(l+1,t).toLowerCase()}return""},q=P(a({__name:"index",props:{modelValue:{},url:{},name:{default:"file"},temp:{type:Boolean},data:{},headers:{},type:{},limit:{default:1},maxSize:{},multiple:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},deletable:{type:Boolean,default:!0},showProgress:{type:Boolean,default:!0},showFileList:{type:Boolean,default:!0},acceptMime:{},emitsType:{},sizeType:{default:()=>["original","compressed"]},sourceType:{default:()=>["album","camera"]},uploadText:{default:""},uploadIcon:{default:""},uploadIconSize:{default:"48rpx"},uploadIconColor:{default:"#999999"},uploadItemSize:{default:"160rpx"},beforeUpload:{},beforeDelete:{}},emits:["update:modelValue","progress","change","delete","success","fail"],setup(e,{emit:l}){const t=e,a=l,P=s(),O=o(),U=[".jpg",".jpeg",".png",".gif",".bmp",".ico"],D=[".mp4",".avi",".flv",".rmvb",".mov"],q=[".zip",".rar",".iso",".7z",".tar",".gz",".arj",".bz2"],G=[".txt",".doc",".docx",".xls",".xlsx",".ppt",".pptx",".pdf",".pem"],H=i([]),J={image:10485760,video:31457280,package:31457280,document:31457280},K=()=>{switch(t.type){case"picture":return"image";case"video":return"video";default:return"all"}},N=()=>{if(t.acceptMime)return t.acceptMime;switch(t.type){case"picture":return U;case"video":return D;case"document":return G;case"package":return q;default:return}},Q=async()=>{if(t.disabled)return;if(!O.isLogin)return P.error("请登录后再操作!"),setTimeout(()=>{j({url:"/pages/login/index"})},1800);if(t.limit-H.value.length<=0)return void P.show(`最多只能上传${t.limit}个文件`);const e=await B({type:K(),count:t.limit,compressed:!1,sizeType:t.sizeType,sourceType:t.sourceType,extension:N()});await R(e)},R=async e=>{for(const l of e.tempFiles){let e=t.maxSize||0;-1===e&&(e=J[t.type]||0);const a=l.size||0;if(e>0&&a>e){const l=e/1024/1024;P.warning(`文件大小不能超过${l.toFixed(0)}MB`);continue}if(t.beforeUpload){if(!(await t.beforeUpload(l)))continue}const s=L(l);H.value.push(s),await W(s,H.value.length-1)}},W=async(e,l)=>{try{const s=t.temp?"temporary":"permanent",o=await C.upload(t.type,s,{filePath:e.url,formData:t.data},e=>{H.value[l].progress=e});H.value[l].status="success",H.value[l].url=o.url,a("success",e,o),X()}catch(s){H.value[l].errMsg=s,H.value[l].status="failed",a("fail",e,s)}},X=()=>{const e=H.value.filter(e=>"success"===e.status);let l;if("object"===t.emitsType){const t=[];for(const l of e)t.push({url:l.url,ext:l.ext,size:l.size,name:l.name});l=t}else l=e.map(e=>e.url);(!t.multiple||t.limit<=1)&&(l=l.length?l[0]:""),a("update:modelValue",l),a("change",e)},Y=e=>{const l=H.value[e];if("image"===l.fileType){const e=H.value.filter(e=>"image"===e.fileType).map(e=>e.url),t=e.indexOf(l.url);S({urls:e,current:t})}else"video"===l.fileType&&("function"==typeof uni.previewMedia?uni.previewMedia({sources:[{url:l.url,type:"video"}]}):P.warning("当前环境不支持视频预览"))};return u(()=>t.modelValue,e=>{if(!e)return void(H.value=[]);const l=[];(Array.isArray(e)?e:[e]).forEach(e=>{let t=!1;if("object"==typeof e&&0===Object.keys(e).length&&(t=!0),!t){const t=String((null==e?void 0:e.url)||e||"");l.push({url:t,size:(null==e?void 0:e.size)||0,ext:(null==e?void 0:e.ext)||E(t),name:(null==e?void 0:e.name)||$(t),fileType:(null==e?void 0:e.fileType)||A(t),status:"success"})}}),H.value=l},{immediate:!0}),(e,l)=>{const s=r(d("wd-toast"),n),o=z,i=_,u=r(d("wd-icon"),c),j=k,C=x,S=r(d("wd-loading"),p);return f(),m(C,{class:"uploader"},{default:y(()=>[g(s),g(C,{class:"flex flex-wrap gap-2.5"},{default:y(()=>[e.showFileList?(f(),m(C,{key:0,class:"flex flex-wrap gap-2.5"},{default:y(()=>[(f(!0),h(M,null,v(F(H),(l,s)=>(f(),m(C,{key:s,class:"relative overflow-hidden rounded-md border border-br bg-lighter",style:w({width:e.uploadItemSize,height:e.uploadItemSize})},{default:y(()=>["image"===l.fileType?(f(),m(o,{key:0,src:l.url,mode:"aspectFill",class:"block w-full h-full",onClick:e=>Y(s)},null,8,["src","onClick"])):"video"===l.fileType?(f(),m(i,{key:1,src:l.url,class:"block w-full h-full",onClick:e=>Y(s)},null,8,["src","onClick"])):(f(),m(C,{key:2,class:"flex flex-col align-center justify-center text-center p-2"},{default:y(()=>[g(u,{name:"a-rootlist",size:"38rpx",color:"var(--text-color-secondary)"}),g(j,{class:"text-xs text-center text-tx-secondary break-all"},{default:y(()=>[T(I(l.name),1)]),_:2},1024)]),_:2},1024)),"uploading"===l.status?(f(),m(C,{key:3,class:"uploader__loading"},{default:y(()=>[g(S,{size:24}),e.showProgress?(f(),m(j,{key:0,class:"mt-1 text-xs text-white"},{default:y(()=>[T(I(l.progress)+"% ",1)]),_:2},1024)):b("",!0)]),_:2},1024)):b("",!0),"failed"===l.status?(f(),m(C,{key:4,class:"uploader__failed"},{default:y(()=>[g(j,{class:"font-bold text-xs text-danger"},{default:y(()=>[T("上传失败")]),_:1})]),_:1})):b("",!0),!e.disabled&&e.deletable?(f(),m(C,{key:5,class:"uploader__delete",onClick:e=>(async e=>{const l=H.value[e];if(t.beforeDelete&&!(await t.beforeDelete(l,e)))return;H.value.splice(e,1),a("delete",l,e),X()})(s)},{default:y(()=>[g(u,{name:"close",size:"32rpx",color:"#fff"})]),_:2},1032,["onClick"])):b("",!0)]),_:2},1032,["style"]))),128))]),_:1})):b("",!0),g(C,{class:"file-picker",onClick:Q},{default:y(()=>[V(e.$slots,"default",{},()=>[!e.disabled&&F(H).length<e.limit?(f(),m(C,{key:0,class:"flex flex-col items-center justify-center rounded-md border border-br bg-lighter",style:w({width:e.uploadItemSize,height:e.uploadItemSize})},{default:y(()=>[e.uploadIcon?(f(),m(u,{key:0,name:e.uploadIcon,size:e.uploadIconSize,color:e.uploadIconColor},null,8,["name","size","color"])):"picture"===e.type?(f(),m(u,{key:1,name:"camera",size:e.uploadIconSize,color:e.uploadIconColor},null,8,["size","color"])):"video"===e.type?(f(),m(u,{key:2,name:"video1",size:e.uploadIconSize,color:e.uploadIconColor},null,8,["size","color"])):(f(),m(u,{key:3,name:"cloud-upload",size:e.uploadIconSize,color:e.uploadIconColor},null,8,["size","color"])),e.uploadText?(f(),m(j,{key:4,class:"mt-2 text-xs text-tx-secondary"},{default:y(()=>[T(I(e.uploadText),1)]),_:1})):b("",!0)]),_:1},8,["style"])):b("",!0)],!0)]),_:3})]),_:3})]),_:3})}}}),[["__scopeId","data-v-a72457b8"]]),G=a({__name:"upload",setup(e){const l=i(""),t=i([]),a=i(""),s=i("");function o(e,l){console.log("上传成功",e,l)}return(e,i)=>{const u=x,r=O("global-ku-root");return f(),m(r,null,{default:y(()=>[g(u,{class:"p-3"},{default:y(()=>[g(u,{class:"text-tx-placeholder mb-2"},{default:y(()=>[T("当前是上传示例代码")]),_:1}),g(u,{class:"mb-2 p-3 rounded-md bg-page"},{default:y(()=>[g(u,{class:"mb-2 text-xl font-bold text-tx-primary"},{default:y(()=>[T("单图上传")]),_:1}),g(q,{modelValue:F(l),"onUpdate:modelValue":i[0]||(i[0]=e=>U(l)?l.value=e:null),limit:1,type:"picture","upload-text":"单图",onSuccess:o},null,8,["modelValue"])]),_:1}),g(u,{class:"mb-2 p-3 rounded-md bg-page"},{default:y(()=>[g(u,{class:"mb-2 text-xl font-bold text-tx-primary"},{default:y(()=>[T("多图上传")]),_:1}),g(q,{modelValue:F(t),"onUpdate:modelValue":i[1]||(i[1]=e=>U(t)?t.value=e:null),type:"picture",multiple:!0,limit:3,"upload-text":"多图"},null,8,["modelValue"])]),_:1}),g(u,{class:"mb-2 p-3 rounded-md bg-page"},{default:y(()=>[g(u,{class:"mb-2 text-xl font-bold text-tx-primary"},{default:y(()=>[T("视频上传")]),_:1}),g(q,{modelValue:F(a),"onUpdate:modelValue":i[2]||(i[2]=e=>U(a)?a.value=e:null),type:"video","upload-text":"视频"},null,8,["modelValue"])]),_:1}),g(u,{class:"mb-2 p-3 rounded-md bg-page"},{default:y(()=>[g(u,{class:"mb-2 text-xl font-bold text-tx-primary"},{default:y(()=>[T("文件上传")]),_:1}),g(q,{modelValue:F(s),"onUpdate:modelValue":i[3]||(i[3]=e=>U(s)?s.value=e:null),type:"document","upload-text":"文件"},null,8,["modelValue"])]),_:1}),g(u,{class:"mb-2 p-3 rounded-md bg-page"},{default:y(()=>[g(u,{class:"mb-2 text-xl font-bold text-tx-primary"},{default:y(()=>[T("自定义上传地址")]),_:1}),g(q,{modelValue:F(s),"onUpdate:modelValue":i[4]||(i[4]=e=>U(s)?s.value=e:null),type:"all",url:"https://www.x.cn/api/upload",headers:{token:"xxx"},data:{dir:"xxx"},onSuccess:o},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})}}});export{G as default};
