import{y as e,x as a,W as l,X as t,v as u,d as s,r as o,Z as i,au as n,Y as c,w as r,A as v,B as d,a1 as m,c as p,l as h,g,a as f,h as w,k as _,D as x,E as y,a4 as b,aX as k,s as S,m as M,t as $,j as T,aY as j,aZ as C,a_ as I,q as N,G as H,H as W,U as X,o as Y,b as q,e as R,f as P,J as V,_ as z,a9 as B,aL as U,i as A,S as F}from"./index-4glTkX_N.js";import{_ as E}from"./index.BM_KXrMv.js";import{_ as G}from"./wd-message-box.BMMHVq-c.js";import{_ as L,a as O}from"./wd-cell-group.DNEkijk0.js";import{_ as D}from"./wd-picker.C4ro-r7f.js";import{_ as J}from"./wd-button.Bm4eyLOH.js";import{u as Z}from"./useTranslate.By_X5Fzm.js";import"./types.DQ6PHZfF.js";import"./index.mNFG9pMF.js";import"./index.D9GroqTO.js";import"./wd-popup.DsWtaoA5.js";import"./wd-input.DYf8A7Ki.js";const K=N(s({name:"wd-img-cropper",options:{virtualHost:!0,addGlobalClass:!0,styleIsolation:"shared"},props:{...e,modelValue:u(!1),cancelButtonText:String,confirmButtonText:String,disabledRotate:u(!1),fileType:a("png"),quality:l(1),exportScale:l(2),imgSrc:a(""),imgWidth:t(""),imgHeight:t(""),maxScale:l(3),aspectRatio:a("1:1")},emits:["imgloaded","imgloaderror","cancel","confirm","update:modelValue"],setup(e,{expose:a,emit:l}){const t=o(`cropper${i()}`);let u=null,s=null,N=!0,H=null,W=null;const X=.85,Y=e,q=l,{translate:R}=Z("img-cropper"),P=o(0),V=o(!1),z=o(0),B=o(0),U=o(0),A=o(0),F=o(20),E=o(0),G=o(0),L=o(""),O=o(""),D=o(2),K=o(1),Q=o(n().windowWidth/2),ee=o(n().windowHeight/2*X),ae=o(null),le=o(n()),te=o(!0),ue=o([{x:"",y:""},{x:"",y:""}]),se=o(""),oe=o(null),{proxy:ie}=c();r(()=>Y.modelValue,e=>{if(e){H=Y.imgWidth,W=Y.imgHeight,le.value=n();const[e,a]=Y.aspectRatio.split(":").map(Number),l=le.value.windowWidth-2*F.value,u=l*a/e;U.value=l,A.value=u,G.value=(le.value.windowHeight*X-u)/2,E.value=F.value,D.value=Y.exportScale,O.value=u,L.value=l,function(){if(H&&"string"==typeof H&&-1!==H.indexOf("%")){const e=H.replace("%","");H=le.value.windowWidth/100*Number(e),z.value=H}else H&&"number"==typeof H&&(z.value=H);if(W&&"string"==typeof W&&-1!==W.indexOf("%")){const e=Y.imgHeight.replace("%","");W=le.value.windowHeight/100*Number(e),z.value=W}else W&&"number"==typeof W&&(z.value=Number(H))}(),oe.value||(oe.value=I(t.value,ie)),Y.imgSrc&&me()}else de()},{deep:!0,immediate:!0}),r(()=>Y.imgSrc,e=>{e&&me()},{deep:!0,immediate:!0}),r(()=>P.value,e=>{e%90&&(P.value=90*Math.round(e/90))},{deep:!0,immediate:!0}),r(()=>V.value,e=>{u&&clearTimeout(u),e&&(u=setTimeout(()=>{re(!1),clearTimeout(u)},300))},{deep:!0,immediate:!0});const ne=v(()=>d({position:"absolute",right:0,width:"56px","border-radius":"16px","font-size":"16px"})),ce=v(()=>{const e={width:z.value?m(z.value):"auto",height:B.value?m(B.value):"auto",transform:`translate(${m(Q.value-z.value/2)}, ${m(ee.value-B.value/2)}) scale(${K.value}) rotate(${P.value}deg)`,"transition-duration":(V.value?.4:0)+"s"};return d(e)});function re(e){V.value="boolean"==typeof e?e:e.value}function ve(e){if(!e||Y.disabledRotate)return;re(!0),P.value=e;let a=z.value,l=B.value;e/90%2&&(a=B.value,l=z.value);const t=U.value/a,u=A.value/l;K.value=Math.max(t,u),pe()}function de(){const{windowHeight:e,windowWidth:a}=n();K.value=1,P.value=0,Q.value=a/2,ee.value=e/2*X}function me(){Y.imgSrc&&C({src:Y.imgSrc,success:e=>{ae.value=e,function(){let e=z.value,a=B.value;if(W||H)W&&!H?(a=Number(W),e=ae.value.width/ae.value.height*a):(!W&&H||W&&H)&&(e=Number(H),a=ae.value.height/ae.value.width*e);else{const l=ae.value.width/ae.value.height;l>U.value/A.value?(a=A.value,e=a*l):(e=U.value,a=e/l)}const l=U.value/e,t=A.value/a,u=Math.max(l,t);z.value=e,B.value=a,K.value=u}(),de()},fail:()=>{}})}function pe(e){const a=e||K.value;let l=Q.value,t=ee.value,u=z.value,s=B.value;P.value/90%2&&(u=B.value,s=z.value),l=u*a/2+E.value>=l?l:u*K.value/2+E.value,l=E.value+U.value-u*a/2<=l?l:E.value+U.value-u*a/2,t=s*a/2+G.value>=t?t:s*a/2+G.value,t=G.value+A.value-s*a/2<=t?t:G.value+A.value-s*a/2,K.value=a,ee.value=t,Q.value=l}function he(e){if(te.value=!1,1===e.touches.length)ue.value[0]={x:e.touches[0].clientX-Q.value,y:e.touches[0].clientY-ee.value};else{const a=Math.abs(e.touches[1].clientX-e.touches[0].clientX),l=Math.abs(e.touches[1].clientY-e.touches[0].clientY);se.value=Math.sqrt(Math.pow(a,2)+Math.pow(l,2))}}function ge(e){if(!te.value&&N)if("android"===le.value.platform?(s&&clearTimeout(s),s=setTimeout(()=>{N=!0},25)):!N&&(N=!0),1===e.touches.length){const{x:a,y:l}=ue.value[0],t=e.touches[0].clientX-Number(a),u=e.touches[0].clientY-Number(l);Q.value=t,ee.value=u,pe()}else{const a=Math.abs(e.touches[1].clientX-e.touches[0].clientX),l=Math.abs(e.touches[1].clientY-e.touches[0].clientY),t=Math.sqrt(Math.pow(a,2)+Math.pow(l,2)),u=K.value*(t/Number(se.value));K.value=Math.min(u,Y.maxScale),function(){let e=z.value,a=B.value,l=K.value;P.value/90%2&&(e=B.value,a=z.value),e*l<U.value&&(l=U.value/e),a*l<A.value&&(l=A.value/a),pe(l)}(),se.value=Math.sqrt(Math.pow(a,2)+Math.pow(l,2))}}function fe(){te.value=!0}function we(e){q("imgloaded",e)}function _e(e){q("imgloaderror",e)}function xe(){ve(P.value-90)}function ye(){q("cancel"),q("update:modelValue",!1)}function be(){!function(){if(!Y.imgSrc)return;const e=()=>{const e=z.value*K.value*Y.exportScale,a=B.value*K.value*Y.exportScale,l=Q.value-E.value,u=ee.value-G.value;oe.value.translate(l*Y.exportScale,u*Y.exportScale),Y.disabledRotate||oe.value.rotate(P.value*Math.PI/180),oe.value.drawImage(Y.imgSrc,-e/2,-a/2,e,a),oe.value.restore(),oe.value.draw(!1,()=>{!function(){const{fileType:e,quality:a,exportScale:l}=Y;j({width:U.value*l,height:Math.round(A.value*l),destWidth:U.value*l,destHeight:Math.round(A.value*l),fileType:e,quality:a,canvasId:t.value,success:e=>{const a={tempFilePath:e.tempFilePath,width:U.value*l,height:A.value*l};q("confirm",a)},complete:()=>{q("update:modelValue",!1)}},ie)}()})};O.value=A.value,L.value=U.value,e()}()}function ke(){}return a({revertIsAnimation:re,setRoate:ve,resetImg:de}),(e,a)=>{const l=_,u=b,s=k;return e.modelValue?(g(),p(l,{key:0,class:y(`wd-img-cropper ${e.customClass}`),style:x(e.customStyle),onTouchmove:ke},{default:f(()=>[w(l,{class:"wd-img-cropper__wrapper"},{default:f(()=>[w(l,{class:"wd-img-cropper__cut"},{default:f(()=>[w(l,{class:y("wd-img-cropper__cut--top "+(te.value?"":"is-hightlight")),style:x(`height: ${G.value}px;`)},null,8,["class","style"]),w(l,{class:"wd-img-cropper__cut--middle",style:x(`height: ${A.value}px;`)},{default:f(()=>[w(l,{class:y("wd-img-cropper__cut--left "+(te.value?"":"is-hightlight")),style:x(`width: ${E.value}px; height: ${A.value}px;`)},null,8,["class","style"]),w(l,{class:"wd-img-cropper__cut--body",style:x(`width: ${U.value}px; height: ${A.value}px;`)},{default:f(()=>[w(l,{class:"is-gridlines-x"}),w(l,{class:"is-gridlines-y"}),w(l,{class:"is-left-top"}),w(l,{class:"is-left-bottom"}),w(l,{class:"is-right-top"}),w(l,{class:"is-right-bottom"})]),_:1},8,["style"]),w(l,{class:y("wd-img-cropper__cut--right "+(te.value?"":"is-hightlight"))},null,8,["class"])]),_:1},8,["style"]),w(l,{class:y("wd-img-cropper__cut--bottom "+(te.value?"":"is-hightlight"))},null,8,["class"])]),_:1}),w(u,{prop:V.value,"change:prop":"",class:"wd-img-cropper__img",src:e.imgSrc,style:x(ce.value),"lazy-load":!1,onTouchstart:he,onTouchmove:ge,onTouchend:fe,onError:_e,onLoad:we},null,8,["prop","change:prop","src","style"])]),_:1}),w(s,{"canvas-id":t.value,id:t.value,class:"wd-img-cropper__canvas","disable-scroll":!0,style:x(`width: ${Number(L.value)*D.value}px; height: ${Number(O.value)*D.value}px;`)},null,8,["canvas-id","id","style"]),w(l,{class:"wd-img-cropper__footer"},{default:f(()=>[e.disabledRotate?h("",!0):(g(),p(S,{key:0,"custom-class":"wd-img-cropper__rotate",name:"rotate",onClick:xe})),w(l,{class:"wd-img-cropper__footer--button"},{default:f(()=>[w(l,{class:"is-cancel",onClick:ye},{default:f(()=>[M($(e.cancelButtonText||T(R)("cancel")),1)]),_:1}),w(J,{size:"small","custom-style":ne.value,onClick:be},{default:f(()=>[M($(e.confirmButtonText||T(R)("confirm")),1)]),_:1},8,["custom-style"])]),_:1})]),_:1})]),_:1},8,["class","style"])):h("",!0)}}}),[["__scopeId","data-v-e2d7a4cc"]]),Q=N(s({__name:"intro",setup(e){const a=H(),l=W(),t=o(!0),{userInfo:u}=X(l),s=o(!1),i=o(""),n=["未知","男","女"],c=()=>{U({count:1,success:e=>{i.value=e.tempFilePaths[0]||"",s.value=!0}})},r=async e=>{var t;let u=e.tempFilePath||"";(null==(t=e.detail)?void 0:t.avatarUrl)&&(u=e.detail.avatarUrl);const o=await A.upload("picture","permanent",{filePath:u});i.value="",s.value=!1,a.loading({msg:"上传中...",zIndex:9999,cover:!0}),await F.edit({scene:"avatar",value:o.url}),await l.getUser(),a.close()},v=async({value:e})=>{const a=n.indexOf(e);await F.edit({scene:"gender",value:String(a)}),await l.getUser()};return Y(()=>{t.value=!1}),(e,a)=>{const l=R(P("w-loading"),E),o=R(P("wd-toast"),V),d=R(P("wd-message-box"),G),m=R(P("wd-img"),z),h=_,x=B,y=R(P("wd-cell"),L),b=R(P("wd-icon"),S),k=R(P("wd-picker"),D),j=R(P("wd-cell-group"),O),C=R(P("wd-img-cropper"),K),I=q("global-ku-root");return g(),p(I,null,{default:f(()=>[w(l,{show:T(t),delay:500},null,8,["show"]),w(h,null,{default:f(()=>[w(o),w(d),w(h,{class:"mt-3"},{default:f(()=>[w(j,{border:""},{default:f(()=>[w(y,null,{default:f(()=>[w(x,{style:{height:"100%","background-color":"unset"},"open-type":"chooseAvatar",onChooseavatar:r,onClick:c},{default:f(()=>[w(h,{class:"flex flex-col items-center justify-center"},{default:f(()=>[w(h,{class:"w-[110rpx] h-[110rpx] rounded-full bg-light"},{default:f(()=>[w(m,{src:T(u).avatar,width:"100%",height:"100%",round:""},null,8,["src"])]),_:1}),w(h,{class:"text-xs text-tx-placeholder mt-2"},{default:f(()=>[M("点击修改头像")]),_:1})]),_:1})]),_:1})]),_:1}),w(y,{title:"ID"},{default:f(()=>[M($(T(u).sn)+" ",1),w(b,{name:"lock-on"})]),_:1}),w(y,{title:"账号",value:T(u).account,"is-link":!0,onClick:a[0]||(a[0]=a=>e.$go("/bundle/pages/user/change_account"))},null,8,["value"]),w(y,{title:"昵称",value:T(u).nickname,"is-link":!0,onClick:a[1]||(a[1]=a=>e.$go("/bundle/pages/user/change_nickname"))},null,8,["value"]),w(k,{"v-model":T(u).gender,columns:n,"use-default-slot":"",onConfirm:v},{default:f(()=>[w(y,{title:"性别","is-link":"",value:T(u).gender},null,8,["value"])]),_:1},8,["v-model"])]),_:1})]),_:1}),w(h,{class:"my-3"},{default:f(()=>[w(j,{border:""},{default:f(()=>[w(y,{title:"密保手机",value:T(u).mobile||"点击修改","is-link":!0,onClick:a[2]||(a[2]=a=>e.$go("/pages/user/adjust_mobile"))},null,8,["value"]),w(y,{title:"电子邮箱","is-link":!0,value:T(u).email||"点击修改",onClick:a[3]||(a[3]=a=>e.$go("/pages/user/adjust_email"))},null,8,["value"]),w(y,{title:"登录密码","is-link":!0,value:"点击修改",onClick:a[4]||(a[4]=a=>e.$go("/pages/user/change_password"))}),w(y,{title:"账号注销","is-link":!0,value:"不可恢复"})]),_:1})]),_:1}),w(C,{"model-value":T(s),"img-src":T(i),onConfirm:r},null,8,["model-value","img-src"])]),_:1})]),_:1})}}}),[["__scopeId","data-v-7279171c"]]);export{Q as default};
